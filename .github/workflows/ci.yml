name: CI - Build and Test

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  test:
    name: Test on PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php-version: ['8.2', '8.3']

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpass
          MYSQL_DATABASE: todoapp
          MYSQL_USER: todouser
          MYSQL_PASSWORD: todopass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, pdo_mysql, bcmath, gd
          coverage: none

      - name: Start PHP built-in server
        run: |
          php -S localhost:8000 -t public &
          sleep 2
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: todoapp
          DB_USERNAME: todouser
          DB_PASSWORD: todopass

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -u todouser -ptodopass --silent; then
              echo "MySQL is ready"
              break
            fi
            echo "Waiting for MySQL..."
            sleep 2
          done

      - name: Test API Health Endpoint
        run: |
          response=$(curl -s http://localhost:8000/api/health)
          echo "Health check response: $response"
          if echo "$response" | grep -q "healthy"; then
            echo "Health check passed"
          else
            echo "Health check failed"
            exit 1
          fi

      - name: Test API Endpoints
        run: |
          # Test root endpoint
          curl -f http://localhost:8000/api || exit 1

          # Test metrics endpoint
          curl -f http://localhost:8000/api/metrics || exit 1

          # Test todos list
          curl -f http://localhost:8000/api/todos || exit 1

          echo "All API tests passed"

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: php-todo-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run -d --name test-app -p 8001:80 \
            -e DB_HOST=mysql \
            -e DB_DATABASE=todoapp \
            -e DB_USERNAME=todouser \
            -e DB_PASSWORD=todopass \
            php-todo-api:test

          sleep 5

          # Test if container is running
          if [ "$(docker ps -q -f name=test-app)" ]; then
            echo "Docker container started successfully"
            docker stop test-app
            docker rm test-app
          else
            echo "Docker container failed to start"
            exit 1
          fi
